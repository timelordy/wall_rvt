# wall_rvt

## Цель репозитория
Этот репозиторий предназначен для хранения C#-решения, автоматизирующего разделение многослойных стен в Autodesk Revit на отдельные однослойные элементы. Проект помогает BIM-специалистам подготовить модели к детальному анализу, спецификациям и передаче данных в другие системы, где необходимо управлять слоями стен как независимыми объектами.

## Описание задачи и ожидаемый результат
Многослойные стены в Revit состоят из набора слоёв (несущих, утепляющих, облицовочных и т. д.), которые в стандартной модели представлены как единый элемент. Скрипт выполняет следующие действия:

1. Анализирует выбранные или все стены активного документа и считывает их структуру слоёв.
2. Создаёт для каждого слоя отдельную стену с сохранением геометрии, высоты, смещений и материалов.
3. Назначает понятные имена и параметры новым элементам (например, «Этаж 1 — Стена — Слой: Облицовка»), чтобы их легко отфильтровать и специфицировать.
4. Записывает связи между исходной стеной и вновь созданными элементами, чтобы при необходимости можно было отследить источник.

На выходе пользователь получает набор однослойных стен, каждая из которых представляет отдельный слой исходной конструкции и может быть редактирована, специфицирована или выгружена отдельно. Скрипт также может генерировать отчёт об обработанных элементах и о возникших исключениях.

## Требования
- **Autodesk Revit:** 2023 или новее (проект разрабатывался и тестировался на Revit 2023). Более ранние версии могут потребовать изменения целевых библиотек.
- **.NET Framework:** 4.8 (именно эту версию использует Revit 2023 для внешних приложений).
- **Среда разработки:** Visual Studio 2019/2022 с установленным рабочим набором «Desktop development with C#».
- **Библиотеки Revit API:** `RevitAPI.dll` и `RevitAPIUI.dll`, устанавливаются вместе с Revit и подключаются как ссылки в проекте.
- **Дополнительно (по желанию):** Revit Lookup для инспектирования параметров и конфигураций элементов, а также Revit Add-In Manager для упрощённого подключения аддинов.

## Установка
1. Склонируйте репозиторий или скачайте архив с исходным кодом:
   ```bash
   git clone https://github.com/<your_org>/wall_rvt.git
   ```
2. Откройте решение в Visual Studio и убедитесь, что целевая платформа — .NET Framework 4.8.
3. Добавьте ссылки на `RevitAPI.dll` и `RevitAPIUI.dll`, расположенные по адресу `C:\Program Files\Autodesk\Revit 2023\` (или соответствующему пути вашей версии Revit).
4. Настройте пост-обработку сборки (Post-Build event), чтобы собранная DLL копировалась в папку `%APPDATA%\Autodesk\Revit\Addins\2023` вместе с `.addin`-файлом.
5. Отредактируйте `.addin`-файл, указав путь к скомпилированной DLL и класс, реализующий `IExternalCommand`.

## Запуск C#-скрипта в Revit
1. Запустите Revit и откройте проект, содержащий стены, которые нужно разделить.
2. Перейдите на вкладку **Дополнения (Add-Ins)** → **Внешние команды (External Tools)**.
3. Выберите пункт меню, соответствующий скрипту разделения стен (название задаётся в `.addin`-файле).
4. В появившемся диалоге укажите параметры обработки (например, фильтрацию по типу стен, необходимость копировать параметры и т. д.) и нажмите **ОК**.
5. После завершения работы скрипта проверьте созданные однослойные стены в 3D-виде или в ведомости, чтобы убедиться, что геометрия и параметры перенесены корректно.

## Пример сценария использования
- **Задача:** подготовить модель для подрядчика, который работает только с несущими слоями.
- **Действия:** выполните команду, выберите фильтр «Обрабатывать только несущие слои» и задайте маску именования «{Level} — {HostWall} — {LayerName}».
- **Результат:** скрипт создаст отдельные стены только для несущих слоёв, перенесёт необходимые параметры (марки, толщину, материал) и поместит элементы в выделенный рабочий набор «Несущие — Разделённые стены».

## Настройка параметров
- **Фильтрация стен:** можно ограничить обработку выбранным набором элементов, типом стены или уровнем.
- **Шаблон именования:** задаёт структуру имени новых стен. Используйте плейсхолдеры `{Level}`, `{HostWall}`, `{LayerName}`, `{Phase}`.
- **Копирование параметров:** выберите, какие параметры из исходной стены нужно перенести (например, общие параметры проекта или пользовательские параметры).
- **Толщина слоя и смещения:** при необходимости укажите поправочные коэффициенты, если требуется округление или компенсация для экспортных форматов.

## Устранение типичных ошибок
- **Отсутствуют ссылки на библиотеки Revit API.** Убедитесь, что `RevitAPI.dll` и `RevitAPIUI.dll` подключены как ссылки и помечены как `Copy Local = False`.
- **Команда не отображается в Revit.** Проверьте правильность `.addin`-файла: путь к DLL, имя класса и пространства имён должны совпадать.
- **Скрипт обрабатывает не все стены.** Убедитесь, что фильтры и набор выбора заданы корректно и что стена действительно многослойная (имеет несколько слоёв в структуре).
- **Ошибки при создании новых стен.** Проверьте, что уровни и типы стен доступны в документе, а также что у пользователя есть права на запись в текущий рабочий набор.
- **Неверная геометрия после разделения.** Убедитесь, что у исходной стены корректно настроены смещения базовой и верхней границы, а также что включён режим копирования смещений для слоёв.

## Полезные ссылки по Revit API
- [Официальная документация Revit API](https://help.autodesk.com/view/RVT/2023/RUS/?guid=GUID-2DBE0E90-ED7F-4F2B-9918-925E92D34A6D)
- [Примеры из SDK Autodesk Revit](https://help.autodesk.com/cloudhelp/2023/RUS/Revit-API/files/GUID-37CC22E1-074D-4F8F-9E07-9A84039E9293-htm.html)
- [Сообщество Revit API на форуме Autodesk](https://forums.autodesk.com/t5/revit-api/ct-p/160)

## Лицензия и вклад
Проект распространяется под лицензией MIT — подробности см. в файле [LICENSE](LICENSE).

Будем рады вашим предложениям и запросам. Чтобы внести вклад, создайте форк репозитория, подготовьте изменения и отправьте pull-request с описанием решения. Перед отправкой убедитесь, что код соответствует требованиям и проходит тестирование в вашей версии Revit.
